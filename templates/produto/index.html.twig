{% extends 'base.html.twig' %}

{% block title %}Hello ProdutoController!{% endblock %}

{% block body %}

<div class="container-xl">
	<div class="table-responsive">
		<div class="table-wrapper">
			<div class="table-title">
				<div class="row">
					<div class="col-sm-6">
						<h2>Gerenciamento de <b>produtos</b></h2>
					</div>
					<div class="col-sm-6">
						<a href="#addEmployeeModal" class="btn btn-success" data-toggle="modal"><i class="material-icons">&#xE147;</i> <span>Add novo produto</span></a>
						<a href="#deleteEmployeeModal" class="btn btn-danger" data-toggle="modal"><i class="material-icons">&#xE15C;</i> <span>Deletar</span></a>						
					</div>
				</div>
			</div>
			<table class="table table-striped table-hover">
				<thead>
					<tr>
						<th>
							<span class="custom-checkbox">
								<input type="checkbox" id="selectAll">
								<label for="selectAll"></label>
							</span>
						</th>
						<th>Nome</th>
						<th>Valor</th>
						<th>Categoria</th>
						<th>Criado em</th>
						<th>Atualizado em</th>
						<th>Ações</th>
					</tr>
				</thead>
				<tbody>
                {% for produto in produtos %}
					<tr>
						<td>
							<span class="custom-checkbox">
								<input type="checkbox" id="checkbox1" name="options[]" class="checked" value="{{produto.id}}">
								<label for="checkbox1"></label>
							</span>
						</td>
						<td>{{produto.nome}}</td>
						<td>{{produto.valor}}</td>
						<td>{{produto.categoriaId.nome}}</td>
						<td>{{produto.createAt|date}}</td>
						<td>{{produto.updateAt|date}}</td>
						<td>
							<a href="#editEmployeeModal" class="edit" data-toggle="modal" 
							onclick="valoresEdit('{{produto.id}}', '{{produto.nome}}', '{{produto.valor}}', {{produto.categoriaId.id}})">
								<i class="material-icons" data-toggle="tooltip" title="Editar">&#xE254;</i>
							</a>
							<a href="#deleteEmployeeModal" class="delete" data-toggle="modal"  onclick="pegaId({{produto.id}})">
								<i class="material-icons" data-toggle="tooltip" title="Deletar">&#xE872;</i>
							</a>
						</td>
					</tr>
                {% endfor %}
				</tbody>
			</table>
			<div class="clearfix">
				<div class="hint-text">Showing <b>5</b> out of <b>25</b> entries</div>
				<ul class="pagination">
					<li class="page-item disabled"><a href="#">Previous</a></li>
					<li class="page-item"><a href="#" class="page-link">1</a></li>
					<li class="page-item"><a href="#" class="page-link">2</a></li>
					<li class="page-item active"><a href="#" class="page-link">3</a></li>
					<li class="page-item"><a href="#" class="page-link">4</a></li>
					<li class="page-item"><a href="#" class="page-link">5</a></li>
					<li class="page-item"><a href="#" class="page-link">Next</a></li>
				</ul>
			</div>
		</div>
	</div>        
</div>
<!-- Add Modal HTML -->
<div id="addEmployeeModal" class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content">
			<form>
				<div class="modal-header">						
					<h4 class="modal-title">Add Produtos</h4>
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				</div>
				<div class="modal-body">					
					<div class="form-group">
						<label>Nome</label>
						<input type="text" id="AddNome" name="AddNome" class="form-control" required>
					</div>
					<div class="form-group">
						<label>Valor</label>
						<input type="text" id="AddValor" name="AddValor" class="form-control" required>
					</div>
					<div class="form-group">
						<label>Categoria</label>
						<select class="form-control" name="AddCategoria" id="AddCategoria">
							<option selected>Categoria...</option>
							{% for categoria in categorias %}
							<option value="{{categoria.id}}"> {{categoria.nome}} </option>
							{% endfor %}
						</select>
					</div>							
				</div>
				<div class="modal-footer">
					<input type="button" class="btn btn-default" data-dismiss="modal" value="Cancel">
					<button type="button" class="btn btn-success" onclick="adicionarProduto()">Cadastrar</button>
				</div>
			</form>
		</div>
	</div>
</div>
<!-- Edit Modal HTML -->
<div id="editEmployeeModal" class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content">
			<form>
				<div class="modal-header">						
					<h4 class="modal-title">Editar Produto</h4>
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				</div>
				<div class="modal-body">					
					<div class="form-group">
						<label>Nome</label>
						<input type="text" id="EditNome" name="EditNome" class="form-control" required>
					</div>
					<div class="form-group">
						<label>Valor</label>
						<input type="text" id="EditValor" name="EditValor" class="form-control" required>
					</div>
					<div class="form-group">
						<label>Categoria</label>
						<select class="form-control" name="EditCategoria" id="EditCategoria">
							{% for categoria in categorias %}
							<option value="{{categoria.id}}"> {{categoria.nome}} </option>
							{% endfor %}
						</select>  

					</div>				
				</div>
				<div class="modal-footer">
					<input type="button" class="btn btn-default" data-dismiss="modal" value="Cancelar">
					<button type="button" id="EditSalvar" class="btn btn-info" value="" onclick="atualizarProduto(this.value)">Salvar</button>
				</div>
			</form>
		</div>
	</div>
</div>
<!-- Delete Modal HTML -->
<div id="deleteEmployeeModal" class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content">
			<form>
				<div class="modal-header">						
					<h4 class="modal-title">Deletar Produto</h4>
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				</div>
				<div class="modal-body">					
					<p>Você tem certeza que deseja deletar esse produto?</p>
					<p class="text-warning"><small>Essa ação não pode ser desfeita.</small></p>
				</div>
				<div class="modal-footer">
					<input type="button" class="btn btn-default" data-dismiss="modal" value="Cancelar">
					<input type="submit" class="btn btn-danger" value="Deletar" onclick="verificaDelete()">
				</div>
			</form>
		</div>
	</div>
</div>

<script>
	//Array dos produtos selecionados para delete
	var checados = [];

	// função para verificar os produtos selecionados e carregar o array
	$(document).ready(function() {
        $(".checked").click(function(e) {
			checados = []
            $.each($("input[name='options[]']:checked"), function(){            
                checados.push($(this).val());
            });
        });
    });

	// Id para ser usado no delete unico de um produto
	var id;
	function pegaId(produtoId){
		id = produtoId;
	}

	// pega os valores e passa para a modal de edição
	function valoresEdit(id, nome, valor, categoria)
	{
		document.getElementById('EditSalvar').value = id;
		document.getElementById('EditNome').value = nome;
		document.getElementById('EditValor').value = valor;
		document.getElementById('EditCategoria').value = categoria;
	}

	function atualizarProduto(editId){
		var nome = document.getElementById('EditNome').value;
		var valor = document.getElementById('EditValor').value;
		var categoria = document.getElementById('EditCategoria').value;

		$.ajax({
		type : "PUT",
		url : '/api/produto/' + editId,
		dataType: 'json',
		data :
		JSON.stringify({
			nome: nome,
			valor: valor,
			categoria_id: categoria
		}),
		//headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
		success : function(data) {
		console.log(data)
		alert("Produto atualizado com sucesso")
		location.reload();
		},
		error: function(error){
			console.log(error.responseText);
		}
  		});

	}

	function adicionarProduto()
	{
		var nome = document.getElementById('AddNome').value;
		var valor = document.getElementById('AddValor').value;
		var categoria = document.getElementById('AddCategoria').value;

		$.ajax({
		type : "POST",
		url : '/api/produto',
		dataType: 'json',
		data :
		JSON.stringify({
			nome: nome,
			valor: valor,
			categoria_id: categoria
		}),
		//headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
		success : function(data) {
			console.log(data);
			alert("Produto cadastrado com sucesso");
			location.reload();
		},
		error: function(error){
			console.log(error.responseText);
		}
  		});
	}

	//verifica se está sendo chamado um delete unico ou multiplo
	function verificaDelete()
	{
		if (checados.length === 0) {
			deletar(id)
		} else {
			deletarProdutos()
		}
	}

	function deletarProdutos()
	{
		if (checados.length === 0) {
			alert("Selecione os produtos que deseja deletar!")
		} else {
			for (var i = 0; i < checados.length; i ++)
			{
				$.ajax({
				type : "DELETE",
				url : '/api/produto/' + checados[i],
				dataType: 'json',
				//headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
				success : function(data) {
				console.log(data)
				alert("Produto deletado com sucesso")
				location.reload();
				},
				error: function(error){
					console.log(error.responseText);
				}
				});
			}
		}
    }

	function deletar(id)
	{
		$.ajax({
			type : "DELETE",
			url : '/api/produto/' + id,
			dataType: 'json',
			//headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
			success : function(data) {
			console.log(data)
			alert("Produto deletado com sucesso")
			location.reload();
			},
			error: function(error){
				console.log(error.responseText);
			}
			});
	}
	
   
</script>

{% endblock %}
