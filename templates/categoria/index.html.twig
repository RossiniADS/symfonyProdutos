{% extends 'base.html.twig' %}

{% block title %}Hello CategoriaController!{% endblock %}

{% block body %}
<div class="container-xl">
	<div class="table-responsive">
		<div class="table-wrapper">
			<div class="table-title">
				<div class="row">
					<div class="col-sm-6">
						<h2>Gerenciamento de <b>Categorias</b></h2>
					</div>
					<div class="col-sm-6">
						<a href="#addEmployeeModal" class="btn btn-success" data-toggle="modal"><i class="material-icons">&#xE147;</i> <span>Add nova Categoria</span></a>
						<a href="#deleteEmployeeModal" class="btn btn-danger" data-toggle="modal"><i class="material-icons">&#xE15C;</i> <span>Deletar</span></a>						
					</div>
				</div>
			</div>
			<table class="table table-striped table-hover">
				<thead>
					<tr>
						<th>
							<span class="custom-checkbox">
								<input type="checkbox" id="selectAll">
								<label for="selectAll"></label>
							</span>
						</th>
						<th>Nome</th>
						<th>Código</th>
						<th>Ações</th>
					</tr>
				</thead>
				<tbody>
                {% for categoria in categorias %}
					<tr>
						<td>
							<span class="custom-checkbox">
								<input type="checkbox" id="checkbox1" name="options[]" class="checked" value="{{categoria.id}}">
								<label for="checkbox1"></label>
							</span>
						</td>
						<td>{{categoria.nome}}</td>
						<td>{{categoria.codigo}}</td>
						<td>
							<a href="#editEmployeeModal" class="edit" data-toggle="modal" 
							onclick="valoresEdit('{{categoria.id}}', '{{categoria.nome}}', '{{categoria.codigo}}')">
								<i class="material-icons" data-toggle="tooltip" title="Editar">&#xE254;</i>
							</a>
							<a href="#deleteEmployeeModal" class="delete" data-toggle="modal"  onclick="pegaId({{categoria.id}})">
								<i class="material-icons" data-toggle="tooltip" title="Deletar">&#xE872;</i>
							</a>
						</td>
					</tr>
                {% endfor %}
				</tbody>
			</table>
			<div class="clearfix">
				<div class="hint-text">Showing <b>5</b> out of <b>25</b> entries</div>
				<ul class="pagination">
					<li class="page-item disabled"><a href="#">Previous</a></li>
					<li class="page-item"><a href="#" class="page-link">1</a></li>
					<li class="page-item"><a href="#" class="page-link">2</a></li>
					<li class="page-item active"><a href="#" class="page-link">3</a></li>
					<li class="page-item"><a href="#" class="page-link">4</a></li>
					<li class="page-item"><a href="#" class="page-link">5</a></li>
					<li class="page-item"><a href="#" class="page-link">Next</a></li>
				</ul>
			</div>
		</div>
	</div>        
</div>
<!-- Add Modal HTML -->
<div id="addEmployeeModal" class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content">
			<form>
				<div class="modal-header">						
					<h4 class="modal-title">Add Categorias</h4>
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				</div>
				<div class="modal-body">					
					<div class="form-group">
						<label>Nome</label>
						<input type="text" id="AddNome" name="AddNome" class="form-control" required>
					</div>
					<div class="form-group">
						<label>Código</label>
						<input type="text" id="AddCodigo" name="AddCodigo" class="form-control" required>
					</div>				
				</div>
				<div class="modal-footer">
					<input type="button" class="btn btn-default" data-dismiss="modal" value="Cancel">
					<input type="submit" class="btn btn-success" value="Add" onclick="adicionarCategoria()">
				</div>
			</form>
		</div>
	</div>
</div>
<!-- Edit Modal HTML -->
<div id="editEmployeeModal" class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content">
			<form>
				<div class="modal-header">						
					<h4 class="modal-title">Editar Categoria</h4>
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				</div>
				<div class="modal-body">					
					<div class="form-group">
						<label>Nome</label>
						<input type="text" id="EditNome" name="EditNome" class="form-control" required>
					</div>
					<div class="form-group">
						<label>Código</label>
						<input type="text" id="EditCodigo" name="EditCodigo" class="form-control" required>
					</div>		
				</div>
				<div class="modal-footer">
					<input type="button" class="btn btn-default" data-dismiss="modal" value="Cancelar">
					<button type="button" id="EditSalvar" class="btn btn-info" value="" onclick="atualizarCategoria(this.value)">Salvar</button>
				</div>
			</form>
		</div>
	</div>
</div>
<!-- Delete Modal HTML -->
<div id="deleteEmployeeModal" class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content">
			<form>
				<div class="modal-header">						
					<h4 class="modal-title">Deletar Categoria</h4>
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				</div>
				<div class="modal-body">					
					<p>Você tem certeza que deseja deletar essa categoria?</p>
					<p class="text-warning"><small>Essa ação não pode ser desfeita.</small></p>
				</div>
				<div class="modal-footer">
					<input type="button" class="btn btn-default" data-dismiss="modal" value="Cancelar">
					<input type="submit" class="btn btn-danger" value="Deletar" onclick="verificaDelete()">
				</div>
			</form>
		</div>
	</div>
</div>

<script>
	//Array dos categorias selecionados para delete
	var checados = [];

	// função para verificar os categorias selecionados e carregar o array
	$(document).ready(function() {
        $(".checked").click(function(e) {
			checados = []
            $.each($("input[name='options[]']:checked"), function(){            
                checados.push($(this).val());
            });
        });
    });

	// Id para ser usado no delete unico de um categoria
	var id;
	function pegaId(categoriaId){
		id = categoriaId;
	}

	// pega os valores e passa para a modal de edição
	function valoresEdit(id, nome, codigo)
	{
		document.getElementById('EditNome').value = nome;
		document.getElementById('EditCodigo').value = codigo;
		document.getElementById('EditSalvar').value = id;
	}

	function atualizarCategoria(editId){
		var nome = document.getElementById('EditNome').value;
		var codigo = document.getElementById('EditCodigo').value;

		$.ajax({
		type : "PUT",
		url : '/api/categoria/' + editId,
		dataType: 'json',
		data :
		JSON.stringify({
			nome: nome,
			codigo: codigo
		}),
		//headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
		success : function(data) {
		console.log(data)
		alert("Categoria atualizada com sucesso")
		location.reload();
		},
		error: function(error){
			console.log(error.responseText);
		}
  		});

	}

	function adicionarCategoria()
	{
		var nome = document.getElementById('AddNome').value;
		var codigo = document.getElementById('AddCodigo').value;

		$.ajax({
		type : "POST",
		url : '/api/categoria',
		dataType: 'json',
		data :
		JSON.stringify({
			nome: nome,
			codigo: codigo
		}),
		//headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
		success : function(data) {
		console.log(data)
		alert("Categoria cadastrada com sucesso")
		location.reload();
		},
		error: function(error){
			console.log(error.responseText);
		}
  		});
	}

	//verifica se está sendo chamado um delete unico ou multiplo
	function verificaDelete()
	{
		if (checados.length === 0) {
			deletar(id)
		} else {
			deletarCategorias()
		}
	}

	function deletarCategorias()
	{
		if (checados.length === 0) {
			alert("Selecione as categorias que deseja deletar!")
		} else {
			for (var i = 0; i < checados.length; i ++)
			{
				$.ajax({
				type : "DELETE",
				url : '/api/categoria/' + checados[i],
				dataType: 'json',
				//headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
				success : function(data) {
				console.log(data)
				alert("Categoria deletada com sucesso")
				location.reload();
				},
				error: function(error){
					console.log(error.responseText);
				}
				});
			}
		}
    }

	function deletar(id)
	{
		$.ajax({
			type : "DELETE",
			url : '/api/categoria/' + id,
			dataType: 'json',
			//headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
			success : function(data) {
			console.log(data)
			alert("Categoria deletada com sucesso")
			location.reload();
			},
			error: function(error){
				console.log(error.responseText);
			}
			});
	}
	
   
</script>
{% endblock %}
